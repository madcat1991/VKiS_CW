<head>
    <link rel="stylesheet" href="CSS\chat.css" type="text/css"/>
</head>
<body bgcolor="#FF5500">
<h1>Девайс сетевой двухканальный прямого действия, оранжевый (0.46a)</h1>

<div style='float: left'>
    <div id='chatLog'>
    </div>
    <!--<input id='inputbox' type='text' onkeypress='edit_keypress(event)'/>-->
    <div id='inputbox' contenteditable onkeypress='edit_keypress(event)'></div>
</div>

<div id='drawingPanel'>
    <div id='drawingPanel_tabs'>
        <span class='tab_switcher_span active_tab' id='dp_tab_switch_public'>Общая доска для рисования</span>
        <span class='tab_switcher_span inactive_tab' id='dp_tab_switch_private'>Составление графического сообщения</span>
    </div>
    <div id='drawing_public'>
        <canvas class='drawing_canvas' width='500' height='320' id='public_canvas'></canvas>
        <div class='draw_toolbar' id='public_draw_tools'>Тут будут инструменты рисования</div>
    </div>
    <div id='drawing_private'>
        <canvas class='drawing_canvas' id='private_canvas'></canvas>
        <div class='draw_toolbar' id='private_draw_tools'>Тут будут инструменты рисования и кнопка ОТПРАВИТЬ</div>
    </div>
</div>



<script type="text/javascript">
    var server_ip = "127.0.0.1";
    
    // утилиты
    
    window.$ = function(id) {
        return document.getElementById(id); // йоу, теперь мы типа как jQuery, йоу!
    };
    
    var rowcount = 0; // число строк таблицы в чате
    
    // добавление строки в лог чата
    // Использование: logg(служебное_сообщение) или logg(автор, сообщение)
    var logg = function(cell1, cell2) { 
        // раскраска строк в зебру
        rowcount += 1;
        var rowclass = '';
        if (rowcount % 2 == 0)
            rowclass = 'chatRow_even';
        else
            rowclass = 'chatRow_odd';
        
        var text = "";
        if (!cell2) {
            text = "<div class='chatString " + rowclass + "'>" + cell1 + "</div>";
        } else {
            text = "<div class='chatString " + rowclass + "'>\n" + 
                   "  <div class='usernick'>" + cell1 + "</div>\n" + 
                   "  <div class='messageBody'>" + cell2 + "</div\n>" + 
                   "</div>\n";
        }
        $('chatLog').innerHTML = $('chatLog').innerHTML + text;
        $('chatLog').scrollTop = $('chatLog').scrollHeight;
    };
    
    // общение с сервером - уровень пакетов/датаграмм
    
    var datagram_recieved = function (packet) {
        /// я ОЧЕНЬ надеюсь, что packet содержит датаграмму целиком, 
        /// а не первые N байт. Потому что как выдернуть остальные??
        datagram = JSON.parse(packet);
        
        if (datagram.type == 'text')
            text_message_recieved(datagram.sender, datagram.value);
        else if (datagram.type == 'notify')
            notification_recieved(datagram);
    };
    
    
    var send_datagram = function(datagram) { 
        msg = JSON.stringify(datagram);
        packet = msg;
        window.ws.send(packet);
    };
    
    // общение с сервером - уровень текстовых сообщений
    var send_text_message = function (msg_text) {
        datagram = {'type': 'text', 'value': msg_text};
        send_datagram(datagram);
    };
    
    // получение текстового сообщения
    var text_message_recieved = function (sender, msg_text) { 
        //время на клиенте
        date = new Date();
        clientTime = " (" + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + ")";
        
        logg("<b>" + sender + clientTime + ":</b>", msg_text);
    };
    
    // системные сообщения
    var notification_recieved = function (datagram) {
        if (datagram.subtype == 'user_left')
            logg("<i><b>" + datagram.user + "</b> покинул конференцию.</i>");
        if (datagram.subtype == 'user_joined')
            logg("<i><b>" + datagram.user + "</b> присоединился к конференции.</i>");
    };
    
    // UI  
    var edit_keypress = function (event) {
        if (event.keyCode == 13 && !event.shiftKey) {
            if ($('inputbox').innerHTML != "") {
                send_text_message($('inputbox').innerHTML);
                $('inputbox').innerHTML = ""; // тут внезапно теряется фокус
                
                $('inputbox').blur();  // хитро возвращаем фокус
                $('inputbox').focus();
                
                event.preventDefault(); // не пускаем символ дальше
                return false;
            }
        }
    };
    
    
    $('drawing_public').style.display = 'block';
    
    var toggle_drawing_tabs = function (event) { 
        if ($('drawing_public').style.display == 'block') {
            $('drawing_public').style.display = 'none';
            $('drawing_private').style.display = 'block';
            $('dp_tab_switch_public').className = "tab_switcher_span inactive_tab";
            $('dp_tab_switch_private').className = "tab_switcher_span active_tab";
        } else {
            $('drawing_public').style.display = 'block';
            $('drawing_private').style.display = 'none';
            $('dp_tab_switch_public').className = "tab_switcher_span active_tab";
            $('dp_tab_switch_private').className = "tab_switcher_span inactive_tab";
        }
    };
    
    $('dp_tab_switch_private').onclick = toggle_drawing_tabs;
    $('dp_tab_switch_public').onclick = toggle_drawing_tabs;
    
    // draaaaawing
    
    var public_context = $('public_canvas').getContext('2d');
    
    public_context.fillStyle = "rgb(255,0,0)";
    public_context.strokeRect(30, 30, 50, 50);
    
    public_context.beginPath();
    public_context.moveTo(10,10);
    public_context.lineTo(120,60);
    public_context.stroke();
    
    var currently_drawing = false;
    $('public_canvas').onmousedown = function (event) {
        var x, y;
        x = event.x - event.target.offsetLeft; y = event.y - event.target.offsetTop;
        currently_drawing = true;
        public_context.beginPath();
        public_context.moveTo(x,y);
    };
    $('public_canvas').onmouseup = function (event) {
        currently_drawing = false;
        public_context.stroke();
    };
    $('public_canvas').onmousemove = function (event) {
        if (currently_drawing) {
            var x, y;
            x = event.x - event.target.offsetLeft; y = event.y - event.target.offsetTop;
            public_context.lineTo(x,y);
            public_context.stroke();
        }
    };
    
    // настройка сокета
    (function(){
        if (!window.WebSocket) {
            document.write("<h1>No websockets for you, sorry</h1>");
            return;
        }
        
        window.ws = new WebSocket("ws://" + server_ip + ":17600");
        //logg('Right after creation, ws.readyState=' + ws.readyState)
        
        ws.onopen = function() {
            logg('Подключение к серверу выполнено.');
            
            ws.onmessage = function (evt) { 
                datagram_recieved(evt.data);
            };
            
             ws.onclose = function() { 
                logg('Сервер разорвал соединение.'); 
            };
            
            // сообщаем серверу наш ник, чтобы стать участником чата
            // см. описание протокола, М4, пункт 4а 
            
            if (localStorage.getItem('chat_nick') == null) {
                default_nick = 'Участник #' + (new Date()).getMilliseconds()
                nick = prompt('Введите ваш псевдоним:', default_nick);
                if (nick == null) nick = default_nick;
                localStorage.setItem('chat_nick', nick);
            };
            
            window.chat_nick = localStorage.getItem('chat_nick');
            send_datagram({'type': 'set-name', 'new_name': chat_nick}); // M4

            
            $('inputbox').focus();
        };
        //logg('After setting onopen, ws.readyState=' + ws.readyState)
        
        
        //logg('After setting onmessage, ws.readyState=' + ws.readyState)
        
        ws.onclose = function() { 
            logg('Невозможно подключиться к серверу.'); 
        };
        //logg('After setting onclose, ws.readyState=' + ws.readyState)
        
    })();
</script>
</body>